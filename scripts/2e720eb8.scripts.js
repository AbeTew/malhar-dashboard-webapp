"use strict";angular.module("app",["app.service","app.websocket","ngRoute","ngCookies","ngResource","ngSanitize","ui.dashboard","nvd3ChartDirectives","ui.widgets"]).constant("settings",window.settings).config(["$routeProvider","webSocketProvider","settings",function(a,b,c){c&&b.setWebSocketURL(c.webSocketURL),a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/rest",{templateUrl:"views/main.html",controller:"RestDataCtrl"}).when("/meteor",{templateUrl:"views/main.html",controller:"MeteorCtrl"}).when("/discovery",{templateUrl:"views/main.html",controller:"DiscoveryCtrl"}).when("/apps",{templateUrl:"views/apps.html",controller:"AppsCtrl"}).when("/apps/:appId",{templateUrl:"views/main.html",controller:"DiscoveryCtrl"}).when("/clientdata",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/serverdata",{templateUrl:"views/main.html",controller:"ServerDataCtrl"}).otherwise({redirectTo:"/"}),jQuery.pnotify.defaults.styling="bootstrap3"}]),angular.module("app.service",["app.websocket"]),angular.module("app.service").factory("PieChartDataModel",["WebSocketDataModel",function(a){function b(){}return b.prototype=Object.create(a.prototype),b.prototype.init=function(){a.prototype.init.call(this),this.data=[]},b.prototype.update=function(b){a.prototype.update.call(this,b)},b.prototype.updateScope=function(b){var c=_.reduce(b,function(a,b){return a+parseFloat(b.value)},0),d=_.map(b,function(a){return{key:a.label,y:a.value/c}});d=_.sortBy(d,function(a){return a.key}),a.prototype.updateScope.call(this,d)},b}]).factory("TimeSeriesDataModel",["WebSocketDataModel",function(a){function b(){}return b.prototype=Object.create(a.prototype),b.prototype.init=function(){a.prototype.init.call(this)},b.prototype.update=function(b){a.prototype.update.call(this,b),this.items=[]},b.prototype.updateScope=function(b){b=_.isArray(b)?b[0]:b,this.items.push({timestamp:parseInt(b.timestamp,10),value:parseInt(b.value,10)}),this.items.length>100&&this.items.shift();var c={data:this.items,max:30};a.prototype.updateScope.call(this,c),this.data=[]},b}]).factory("RestTimeSeriesDataModel",["settings","WidgetDataModel","$http",function(a,b,c){function d(){}return d.prototype=Object.create(b.prototype),d.prototype.init=function(){b.prototype.init.call(this),this.mode=this.dataModelOptions?this.dataModelOptions.mode:"MINUTES",this.widgetScope.$on("modeChanged",function(a,b){this.mode=b,this.load()}.bind(this)),this.load()},d.prototype.load=function(){var a={bucket:this.mode,metric:this.dataModelOptions.metric};c.get("/data",{params:a}).success(function(a){var b={data:a,chartOptions:{vAxis:{}}};this.updateScope(b)}.bind(this))},d}]).factory("RestTopNDataModel",["settings","WidgetDataModel","$http",function(a,b,c){function d(){}return d.prototype=Object.create(b.prototype),d.prototype.init=function(){b.prototype.init.call(this),this.load()},d.prototype.load=function(){c.get("/topn",{params:{limit:this.dataModelOptions.limit,dimension:this.dataModelOptions.dimension}}).success(function(a){this.updateScope(a)}.bind(this))},d}]).factory("MeteorTimeSeriesDataModel",["settings","MeteorDdp","WidgetDataModel",function(a,b,c){function d(){var c=new b(a.meteorURL);this.ddp=c;var d=this;c.connect().done(function(){console.log("Meteor connected"),d.update()})}return d.prototype=Object.create(c.prototype),d.prototype.init=function(){c.prototype.init.call(this)},d.prototype.update=function(a){this.items=[],a=a?a:this.dataModelOptions.collection,this.ddp.subscribe(a);var b=this;this.ddp.watch(a,function(a,c){"added"===c&&(b.updateScope(a),b.widgetScope.$apply())})},d.prototype.updateScope=function(a){a.hasOwnProperty("history")?this.items.push.apply(this.items,a.history):this.items.push(a),this.items.length>100&&this.items.splice(0,this.items.length-100);var b={data:this.items,max:30};c.prototype.updateScope.call(this,b),this.data=[]},d}]).factory("MeteorDataModel",["settings","MeteorDdp","WidgetDataModel",function(a,b,c){function d(){var c=new b(a.meteorURL);this.ddp=c;var d=this;c.connect().done(function(){console.log("Meteor connected"),d.update()})}return d.prototype=Object.create(c.prototype),d.prototype.init=function(){c.prototype.init.call(this)},d.prototype.update=function(a){this.items=[],a=a?a:this.dataModelOptions.collection,this.ddp.subscribe(a);var b=this;this.ddp.watch(a,function(a){b.updateScope(a),b.widgetScope.$apply()})},d}]).factory("WebSocketDataModel",["WidgetDataModel","webSocket",function(a,b){function c(){}return c.prototype=Object.create(a.prototype),c.prototype.init=function(){this.topic=null,this.callback=null,this.dataModelOptions&&this.dataModelOptions.defaultTopic&&this.update(this.dataModelOptions.defaultTopic)},c.prototype.update=function(a){var c=this;this.topic&&this.callback&&b.unsubscribe(this.topic,this.callback),this.callback=function(a){c.updateScope(a),c.widgetScope.$apply()},this.topic=a,b.subscribe(this.topic,this.callback,this.widgetScope)},c.prototype.destroy=function(){a.prototype.destroy.call(this),this.topic&&this.callback&&b.unsubscribe(this.topic,this.callback)},c}]).factory("RandomValueDataModel",["WidgetDataModel","$interval",function(a,b){function c(){}return c.prototype=Object.create(a.prototype),c.prototype.init=function(){var a=10*Math.floor(10*Math.random());this.updateScope(a);var c=this;this.intervalPromise=b(function(){var b=a+Math.random();c.updateScope(b)},500)},c.prototype.destroy=function(){a.prototype.destroy.call(this),b.cancel(this.intervalPromise)},c}]).factory("RandomTopNDataModel",["WidgetDataModel","$interval",function(a,b){function c(){}return c.prototype=Object.create(a.prototype),c.prototype.init=function(){this.intervalPromise=b(function(){var a=_.map(_.range(0,10),function(a){return{name:"item"+a,value:Math.floor(100*Math.random())}});this.updateScope(a)}.bind(this),500)},c.prototype.destroy=function(){a.prototype.destroy.call(this),b.cancel(this.intervalPromise)},c}]).factory("RandomTimeSeriesDataModel",["WidgetDataModel","$interval",function(a,b){function c(){}return c.prototype=Object.create(a.prototype),c.prototype.init=function(){function a(){return e+=40*Math.random()-20,e=0>e?0:e>100?100:e}for(var c=30,d=[],e=50,f=Date.now(),g=c-1;g>=0;g--)d.push({timestamp:f-1e3*g,value:a()});var h={data:d,max:c,chartOptions:{vAxis:{}}};this.updateScope(h),this.intervalPromise=b(function(){d.shift(),d.push({timestamp:Date.now(),value:a()});var b={data:d,max:c};this.updateScope(b)}.bind(this),1e3)},c.prototype.destroy=function(){a.prototype.destroy.call(this),b.cancel(this.intervalPromise)},c}]).factory("RandomD3TimeSeriesDataModel",["WidgetDataModel","$interval",function(a,b){function c(){}return c.prototype=Object.create(a.prototype),c.prototype.init=function(){function a(){return e+=Math.round(40*Math.random()-20),e=0>e?0:e>100?100:e}for(var c=30,d=[],e=50,f=Date.now(),g=c-1;g>=0;g--)d.push({timestamp:f-1e3*g,value:a()});var h=[{key:"Series",values:d}];this.updateScope(h),this.intervalPromise=b(function(){d.shift(),d.push({timestamp:Date.now(),value:a()});var b=[{key:"Series",values:d}];this.updateScope(b)}.bind(this),1e3)},c.prototype.destroy=function(){a.prototype.destroy.call(this),b.cancel(this.intervalPromise)},c}]),angular.module("app.service").constant("pieChartSampleData",[{key:"One",y:5},{key:"Two",y:2},{key:"Three",y:9},{key:"Four",y:7},{key:"Five",y:4},{key:"Six",y:3},{key:"Seven",y:7},{key:"Eight",y:4},{key:"Nine",y:3}]).constant("stackedAreaChartSampleData",[{key:"Series 1",values:[[10516752e5,0],[10543536e5,7.2481659343222],[10569456e5,9.2512381306992],[1059624e6,11.341210982529],[10623024e5,14.73482040902],[10648944e5,12.387148007542],[10675764e5,18.436471461827],[10701684e5,19.830742266977],[10728468e5,22.643205829887],[10755252e5,26.743156781239],[10780308e5,29.597478802228],[10807092e5,30.831697585341],[10832976e5,28.054068024708],[1085976e6,29.294079423832],[1088568e6,30.269264061274],[10912464e5,24.934526898906],[10939248e5,24.265982759406],[10965168e5,27.217794897473],[10991952e5,30.802601992077],[11017908e5,36.331003758254],[11044692e5,43.14249870006],[11071476e5,40.558263931958],[11095668e5,42.5436223858],[11122452e5,41.683584710331],[11148336e5,36.375367302328],[1117512e6,40.71968898073],[1120104e6,43.897963036919],[11227824e5,49.797033975368],[11254608e5,47.085993935989],[11280528e5,46.601972859745],[11307348e5,41.567784572762],[11333268e5,47.296923737245],[11360052e5,47.64296961208],[11386836e5,50.781515820954],[11411028e5,52.600229204305],[11437812e5,55.599684490628],[11463696e5,57.920388436633],[1149048e6,53.503593218971],[115164e7,53.522973979964],[11543184e5,49.846822298548],[11569968e5,54.72134161465],[11595888e5,58.186236223191],[11622708e5,63.908065540997],[11648628e5,69.767285129367],[11675412e5,72.534013373592],[11702196e5,77.991819436573],[11726388e5,78.14358440499],[11753136e5,83.702398665233],[11779056e5,91.140859312418],[1180584e6,98.590960607028],[1183176e6,96.245634754228],[11858544e5,92.326364432615],[11885328e5,97.06876533223],[11911248e5,105.8102555626],[11938032e5,114.38348777791],[11963988e5,103.5960494981],[11990772e5,101.72488429307],[12017556e5,89.840147735028],[12042612e5,86.963597532664],[1206936e6,84.075505208491],[1209528e6,93.170105645831],[12122064e5,103.62838083121],[12147984e5,87.458241365091],[12174768e5,85.808374141319],[12201552e5,93.158054469193],[12227472e5,65.97325238236],[12254256e5,44.580686638224],[12280212e5,36.418977140128],[12306996e5,38.727678144761],[1233378e6,36.692674173387],[12357972e5,30.03302280948],[1238472e6,36.707532162718],[1241064e6,52.191457688389],[12437424e5,56.357883979735],[12463344e5,57.629002180305],[12490128e5,66.650985790166],[12516912e5,70.839243432186],[12542832e5,78.731998491499],[12569616e5,72.375528540349],[12595572e5,81.73838788163],[12622356e5,87.539792394232],[1264914e6,84.320762662273],[12673332e5,90.621278391889],[1270008e6,102.47144881651],[12726e8,102.79320353429],[12752784e5,90.529736050479],[12778704e5,76.580859994531],[12805488e5,86.548979376972],[12832272e5,81.879653334089],[12858192e5,101.72550015956],[12884976e5,107.9796485226],[12910932e5,106.16240630785],[12937716e5,114.84268599533],[129645e7,121.60793322282],[12988692e5,133.41437346605],[1301544e6,125.46646042904],[1304136e6,129.76784954301],[13068144e5,128.15798861044],[13094064e5,121.92388706072],[13120848e5,116.7003610087],[13147632e5,88.367701837033],[13173552e5,59.159665765725],[13200336e5,79.793568139753],[13226292e5,75.903834028417],[13253076e5,72.704218209157],[1327986e6,84.936990804097],[13304916e5,93.388148670744]]}]),angular.module("app.websocket",["ui.notify"]).factory("visibly",["$window",function(a){return a.visibly}]).provider("webSocket",function(){var a,b;return{$get:["$q","$rootScope","$timeout","notificationService","visibly",function(c,d,e,f,g){if(!a&&!b)throw"WebSocket URL is not defined";var h=b?b:new WebSocket(a),i=c.defer();h.onopen=function(){i.resolve(),d.$apply(),f.notify({title:"WebSocket",text:"WebSocket connection established.",type:"success",delay:2e3,icon:!1,history:!1})};var j=!1;h.onclose=function(){j||f.notify({title:"WebSocket Closed",text:"WebSocket connection has been closed. Try refreshing the page.",type:"error",icon:!1,hide:!1,history:!1})},h.onerror=function(){j=!0,f.notify({title:"WebSocket Error",text:"WebSocket error. Try refreshing the page.",type:"error",icon:!1,hide:!1,history:!1})};var k={},l=!1;h.onmessage=function(a){if(!l){var b=JSON.parse(a.data),c=b.topic;k.hasOwnProperty(c)&&k[c].fire(b.data)}};var m;return g.onHidden(function(){m=e(function(){l=!0,m=null},6e4)}),g.onVisible(function(){l=!1,m&&e.cancel(m),console.log("visible")}),{send:function(a){var b=JSON.stringify(a);i.promise.then(function(){console.log("send "+b),h.send(b)})},subscribe:function(a,b,c){var d=k[a];if(!d){var e={type:"subscribe",topic:a};this.send(e),d=jQuery.Callbacks(),k[a]=d}d.add(b),c&&c.$on("$destroy",function(){this.unsubscribe(a,b)}.bind(this))},unsubscribe:function(a,b){if(k.hasOwnProperty(a)){var c=k[a];c.remove(b)}}}}],setWebSocketURL:function(b){a=b},setWebSocketObject:function(a){b=a}}}),angular.module("app.service").factory("Gateway",["$rootScope","$q","$http","webSocket","settings",function(a,b,c,d,e){return{getDataTopics:function(){var c=b.defer();return d.subscribe("_latestTopics",function(a){var b=_.reject(a,function(a){return 0!==a.indexOf('AppData{"schema"')}),d=_.map(b,function(a){var b=a.indexOf("{"),c=a.substr(b),d=JSON.parse(c);return{topic:a,appId:d.appId,name:d.topicName,schema:d.schema,type:d.schema.type}});c.resolve(d)},a),d.send({type:"getLatestTopics"}),c.promise},getRunningApps:function(){var a=b.defer(),d=e.restBaseURL+"applications?states=running&jsonp=JSON_CALLBACK";return c.jsonp(d).success(function(b){if(b&&b.apps&&b.apps.length>0){var c=_.reject(b.apps,function(a){return"RUNNING"!==a.state});c=_.sortBy(c,function(a){return-a.startedTime}),a.resolve(c)}}),a.promise},getTopics:function(){var a=b.defer(),c=this.getDataTopics(),d=this.getRunningApps();return b.all({topics:c,apps:d}).then(function(b){var c=b.topics,d=b.apps,e={};_.each(d,function(a){e[a.id]=a}),c=_.reject(c,function(a){return!e.hasOwnProperty(a.appId)}),_.each(c,function(a){var b=e[a.appId];a.appName=b.name,a.appStartedTime=b.startedTime}),c=_.sortBy(c,function(a){return a.name}),a.resolve(c)}),a.promise}}}]),angular.module("app.service").factory("widgetDefs",["settings","WebSocketDataModel","TimeSeriesDataModel","PieChartDataModel",function(a,b,c,d){return[{name:"Value",directive:"wt-scope-watch",dataAttrName:"value",attrs:{"value-class":"alert-info"},dataTypes:["percentage","simple"],dataModelType:b,dataModelOptions:{defaultTopic:a.topic.visualdata.piValue}},{name:"Progressbar",directive:"progressbar",attrs:{"class":"progress-striped",type:"success"},dataAttrName:"value",dataTypes:["percentage","simple"],dataModelType:b,dataModelOptions:{defaultTopic:a.topic.visualdata.progress}},{name:"Line Chart",directive:"wt-line-chart",dataAttrName:"chart",dataTypes:["timeseries"],dataModelType:c,dataModelOptions:{defaultTopic:a.topic.visualdata.chartValue},style:{width:"50%"}},{name:"TopN",directive:"wt-top-n",attrs:{data:"serverTopTen"},dataAttrName:"data",dataTypes:["topN"],dataModelType:b,dataModelOptions:{defaultTopic:a.topic.visualdata.topn}},{name:"Pie Chart",directive:"wt-pie-chart",style:{width:"350px",height:"350px"},dataAttrName:"data",dataTypes:["piechart"],dataModelType:d,dataModelOptions:{defaultTopic:a.topic.visualdata.pieChart}},{name:"Gauge",directive:"wt-gauge",dataAttrName:"value",dataTypes:["percentage","simple"],dataModelType:b,dataModelOptions:{defaultTopic:a.topic.visualdata.percentage},style:{width:"250px"}},{name:"JSON",directive:"wt-json",dataAttrName:"value",dataModelType:b,dataModelOptions:{defaultTopic:a.topic.visualdata.topn}},{name:"WebSocket Debugger",templateUrl:"template/topics.html"}]}]),angular.module("app").controller("MainCtrl",["$scope","$interval","stackedAreaChartSampleData","pieChartSampleData","RandomTimeSeriesDataModel","RandomTopNDataModel",function(a,b,c,d,e,f){var g=[{name:"wt-time",style:{width:"33%"}},{name:"wt-random",style:{width:"33%"}},{name:"wt-scope-watch",attrs:{value:"randomValue"},style:{width:"34%"}},{name:"wt-line-chart",dataAttrName:"chart",dataModelType:e,style:{width:"50%"}},{name:"wt-gauge",attrs:{value:"percentage"},style:{width:"250px"}},{name:"wt-top-n",dataAttrName:"data",dataModelType:f,style:{width:"30%"}},{name:"progressbar",attrs:{"class":"progress-striped",type:"success",value:"percentage"},style:{width:"30%"}},{name:"progressbar2",template:'<div progressbar class="progress-striped" type="info" value="percentage">{{percentage}}%</div>',style:{width:"30%"}},{name:"URLtemplate",templateUrl:"template/percentage.html"},{name:"nvd3-stacked-area-chart",attrs:{data:"stackedAreaChartData",height:"400",showXAxis:"true",showYAxis:"true",xAxisTickFormat:"xAxisTickFormat()"},style:{width:"50%"}},{name:"wt-pie-chart",style:{width:"350px",height:"350px"},attrs:{data:"pieChartData"}}],h=_.map(g,function(a){return{name:a.name}});a.dashboardOptions={widgetButtons:!0,widgetDefinitions:g,defaultWidgets:h},b(function(){a.randomValue=Math.random()},500),a.percentage=5,b(function(){a.percentage=(a.percentage+10)%100},1e3),a.stackedAreaChartData=c,a.xAxisTickFormat=function(){return function(a){return d3.time.format("%x")(new Date(a))}},a.pieChartData=d,a.addWidget=function(b){a.dashboardOptions.addWidget({name:b})},a.addWidgetScopeWatch=function(){a.dashboardOptions.addWidget({name:"scope-watch",attrs:{value:"randomValue"}})}}]),angular.module("app").controller("ServerDataCtrl",["$scope","webSocket","Gateway","settings","widgetDefs",function(a,b,c,d,e){var f=[{name:"Value",title:"Value 1"},{name:"Value",title:"Value 2",dataModelOptions:{defaultTopic:d.topic.visualdata.percentage}},{name:"Progressbar",title:"Progressbar"},{name:"Line Chart",title:"Line Chart 1"},{name:"Line Chart",title:"Line Chart 2",dataModelOptions:{defaultTopic:d.topic.visualdata.chartValue2}},{name:"TopN",title:"Top N"},{name:"Pie Chart",title:"Pie Chart"},{name:"JSON",title:"JSON"},{name:"WebSocket Debugger",title:"WebSocket Debugger"}];a.dashboardOptions={widgetButtons:!0,widgetDefinitions:e,defaultWidgets:f,optionsTemplateUrl:"template/widgetOptions.html"};var g=c.getTopics();a.$on("widgetAdded",function(a,b){a.stopPropagation(),b.dataModel&&b.dataModelOptions&&b.dataModelOptions.defaultTopic&&g.then(function(a){var c=b.dataModelOptions.defaultTopic,d=_.find(a,function(a){return a.name.indexOf(c)>=0});d&&b.dataModel.update(d.topic)})})}]),angular.module("app").controller("RestDataCtrl",["$scope","settings","RestTimeSeriesDataModel","RestTopNDataModel",function(a,b,c,d){var e=[{name:"Line Chart Visits",directive:"wt-historical-chart",dataAttrName:"chart",dataModelType:c,dataModelOptions:{metric:"count"},style:{width:"50%"}},{name:"Line Chart Bandwidth",directive:"wt-historical-chart",dataAttrName:"chart",dataModelType:c,dataModelOptions:{metric:"bandwidth"},style:{width:"50%"}},{name:"Countries",directive:"wt-top-n",dataAttrName:"data",dataModelType:d,dataModelOptions:{dimension:"geoip_country_name",limit:20},style:{width:"33%"}},{name:"Cities",directive:"wt-top-n",dataAttrName:"data",dataModelType:d,dataModelOptions:{dimension:"geoip_city_name",limit:20},style:{width:"33%"}},{name:"Browsers",directive:"wt-top-n",dataAttrName:"data",dataModelType:d,dataModelOptions:{dimension:"agentinfo_name",limit:20},style:{width:"33%"}}],f=[{name:"Line Chart Visits",title:"Visits"},{name:"Line Chart Bandwidth",title:"Bandwidth"},{name:"Countries",title:"Countries"},{name:"Cities",title:"Cities"},{name:"Browsers",title:"Browsers"}];a.dashboardOptions={widgetButtons:!0,widgetDefinitions:e,defaultWidgets:f}}]),angular.module("app").controller("AppsCtrl",["$scope","Gateway",function(a,b){a.showLoading=!0;var c=b.getTopics();c.then(function(b){var c={};_.each(b,function(a){var b=a.appId;if(c.hasOwnProperty(b)){var d=c[b];d.topicCount++}else{var e={id:b,name:a.appName,startedTime:a.appStartedTime,topicCount:1};c[b]=e}}),a.apps=_.sortBy(_.values(c),function(a){return-a.startedTime}),a.showLoading=!1},function(){a.showLoading=!1});var d='<div class="ngCellText" ng-class="col.colIndex()"><span ng-cell-text><a href="#/apps/{{COL_FIELD}}">{{COL_FIELD}}</a></span></div>';a.gridOptions={data:"apps",enableRowSelection:!1,enableColumnResize:!0,showFilter:!0,columnDefs:[{field:"id",displayName:"Id",cellTemplate:d,width:250},{field:"name",displayName:"Name"},{field:"startedTime",displayName:"Start Time",cellFilter:"date:'yyyy-MM-dd HH:mm:ss'",width:200},{field:"topicCount",displayName:"Topic Count",width:150}]}}]),angular.module("app").controller("DiscoveryCtrl",["$scope","$routeParams","webSocket","Gateway","settings","widgetDefs","notificationService",function(a,b,c,d,e,f,g){a.dashboardOptions={useLocalStorage:!1,widgetButtons:!0,widgetDefinitions:f,optionsTemplateUrl:"template/widgetOptions.html"},d.getTopics().then(function(c){function d(a){i.push(a)}if(c.length){c=_.sortBy(c,function(a){return-a.appStartedTime});var e;e=b.appId?b.appId:c[0].appId;var f=_.findWhere(c,{appId:e}),h=_.where(c,{appId:e}),i=[],j=!1;_.each(h,function(a){var b=a.schema.type;"timeseries"===b?d({name:"Line Chart",title:"Line Chart",dataModelOptions:{topic:a.topic}}):"topN"===b?d({name:"TopN",title:"Top N",dataModelOptions:{topic:a.topic}}):"percentage"===b?j?d({name:"Progressbar",title:"Progressbar",dataModelOptions:{topic:a.topic}}):(d({name:"Gauge",title:"Gauge",dataModelOptions:{topic:a.topic}}),j=!0):"piechart"===b&&d({name:"Pie Chart",title:"Pie Chart",dataModelOptions:{topic:a.topic}})}),a.dashboardOptions.loadWidgets(i),g.notify({title:"Dashboard Loaded",text:"Dashboard for application {name} ({id}) has been loaded.".replace("{name}",f.appName).replace("{id}",f.appId),type:"success",delay:5e3,icon:!1,history:!1})}});var h=d.getTopics();a.$on("widgetAdded",function(a,b){a.stopPropagation(),b.dataModel&&b.dataModelOptions&&b.dataModelOptions.topic&&h.then(function(a){var c=b.dataModelOptions.topic,d=null;if(c)d=_.find(a,function(a){return a.topic===c});else{var e=b.dataModelOptions.defaultTopic;d=_.find(a,function(a){return a.name.indexOf(e)>=0})}d&&b.dataModel.update(d.topic)})})}]),angular.module("app").controller("TopicCtrl",["$scope","webSocket","Gateway",function(a,b,c){a.prevTopic=function(){var b=a.topics.indexOf(a.topic),c=(a.topics.length+b-1)%a.topics.length;a.topic=a.topics[c]},a.nextTopic=function(){var b=a.topics.indexOf(a.topic),c=(b+1)%a.topics.length;a.topic=a.topics[c]},a.selectTopic=function(b){a.topic=b};var d=function(b){a.topicData=JSON.stringify(b,null," "),a.$apply()};a.$watch("topic",function(c,e){e&&d&&b.unsubscribe(e.topic,d),c&&(a.topicData="Loading...",a.topicSchema=JSON.stringify(c.schema,null," "),b.subscribe(c.topic,d,a))}),a.topics=[],c.getTopics().then(function(b){a.topics=b,b.length&&(a.topic=a.topics[0])})}]),angular.module("app").controller("WidgetOptionsCtrl",["$scope","webSocket","Gateway","settings",function(a,b,c,d){a.dataSourceName="Gateway ("+d.gatewayHost+")",a.prevTopic=function(){var b=a.topics.indexOf(a.topic),c=(a.topics.length+b-1)%a.topics.length;a.topic=a.topics[c]},a.nextTopic=function(){var b=a.topics.indexOf(a.topic),c=(b+1)%a.topics.length;a.topic=a.topics[c]};var e=a.widget;e&&e.dataModel&&(a.topics=[],e.dataTypes&&(a.dataTypes=e.dataTypes.join(", ")),c.getTopics().then(function(b){e.dataTypes&&(b=_.reject(b,function(a){return!a.schema||!_.contains(e.dataTypes,a.schema.type)})),a.topics=b,a.topic=_.findWhere(a.topics,{topic:e.dataModel.topic})}),a.$watch("topic",function(a){a&&a.topic!==e.dataModel.topic&&(console.log(e.dataModel),e.dataModel.update(a.topic))}),a.selectTopic=function(b){a.topic=b})}]),angular.module("app.service").factory("MeteorDdp",function(){var a=function(a){this.VERSIONS=["pre1"],this.wsUri=a,this.sock,this.defs={},this.subs={},this.watchers={},this.collections={}};return a.prototype._Ids=function(){var a=0;return{next:function(){return++a+""}}}(),a.prototype.connect=function(){var a=this,b=new $.Deferred;return a.sock=new WebSocket(a.wsUri),a.sock.onopen=function(){a.send({msg:"connect",version:a.VERSIONS[0],support:a.VERSIONS})},a.sock.onerror=function(a){b.reject(a)},a.sock.onmessage=function(c){var d=JSON.parse(c.data);switch(console.log(c),d.msg){case"connected":b.resolve(d);break;case"result":a._resolveCall(d);break;case"updated":break;case"changed":a._changeDoc(d);break;case"added":a._addDoc(d);break;case"removed":a._removeDoc(d);break;case"ready":a._resolveSubs(d);break;case"nosub":a._resolveNoSub(d);break;case"addedBefore":a._addDoc(d);break;case"movedBefore":}},b.promise()},a.prototype._resolveNoSub=function(a){if(a.error){var b=a.error;this.defs[a.id].reject(b.reason||"Subscription not found")}else this.defs[a.id].resolve()},a.prototype._resolveCall=function(a){a.error?this.defs[a.id].reject(a.error.reason):"undefined"!=typeof a.result&&this.defs[a.id].resolve(a.result)},a.prototype._resolveSubs=function(a){for(var b=a.subs,c=0;c<b.length;c++)this.defs[b[c]].resolve()},a.prototype._changeDoc=function(a){var b=a.collection,c=a.id,d=a.fields,e=a.cleared,f=this.collections[b];if(d)for(var g in d)f[c][g]=d[g];else if(e)for(var h=0;h<e.length;h++){var i=e[h];delete f[c][i]}var j=f[c];this._notifyWatchers(b,j,c,a.msg)},a.prototype._addDoc=function(a){var b=a.collection,c=a.id;this.collections[b]||(this.collections[b]={}),this.collections[b][c]=a.fields;var d=this.collections[b][c];this._notifyWatchers(b,d,c,a.msg)},a.prototype._removeDoc=function(a){var b=a.collection,c=a.id,d=this.collections[b][c],e=JSON.parse(JSON.stringify(d));delete this.collections[b][c],this._notifyWatchers(b,e,c,a.msg)},a.prototype._notifyWatchers=function(a,b,c,d){if(b=JSON.parse(JSON.stringify(b)),b._id=c,this.watchers[a])for(var e=0;e<this.watchers[a].length;e++)this.watchers[a][e](b,d);else this.watchers[a]=[]},a.prototype._deferredSend=function(a,b,c){var d=this._Ids.next();this.defs[d]=new $.Deferred;var e=c||[],f={msg:a,params:e,id:d};return"method"===a?f.method=b:"sub"===a&&(f.name=b,this.subs[b]=d),this.send(f),this.defs[d].promise()},a.prototype.call=function(a,b){return this._deferredSend("method",a,b)},a.prototype.subscribe=function(a,b){return this._deferredSend("sub",a,b)},a.prototype.unsubscribe=function(a){if(this.defs[b]=new $.Deferred,this.subs[a]){var b=this.subs[a],c={msg:"unsub",id:b};this.send(c)}else this.defs[b].reject(a+" was never subscribed");return this.defs[b].promise()},a.prototype.watch=function(a,b){this.watchers[a]||(this.watchers[a]=[]),this.watchers[a].push(b)},a.prototype.getCollection=function(a){return this.collections[a]||null},a.prototype.getDocument=function(a,b){return this.collections[a][b]||null},a.prototype.send=function(a){console.log("send "+JSON.stringify(a)),this.sock.send(JSON.stringify(a))},a.prototype.close=function(){this.sock.close()},a});